6000-                  4                       .OR             $6000
6000-                  5
6000-                  6                       .IN             constants.asm   ; Constants
4000-            I     1       SCREEN                  .EQU    $4000                   ; 16384
1800-            I     2       SZ_SCRN                 .EQU    $1800                   ; 6144  256*192 pixels, 8-pixels per byte
5800-            I     3       ATTR                    .EQU    $5800                   ; 22528
0300-            I     4       SZ_ATTR                 .EQU    $300                    ; 768   32*24 8-pixel blocks
0060-            I     5       SZ_FONT                 .EQU    $60                             ; 96
5CC0-            I     6       VARS                    .EQU    $5CC0                   ; 23744, used as start of variable space
5F00-            I     7       STACK                   .EQU    $5F00                   ; Stack decrement down from here
0400-            I     8       SIGNATURE               .EQU    $0400                   ; Software signature, used when checking banks.
6000-            I     9
001F-            I    10       CTRL_BANK               .EQU    31                              ; ZX Interface 2.021 bank control port
003F-            I    11       CTRL_LED                .EQU    63                              ; LED for ZX Diagnostic 2.021 cartridge
00FE-            I    12       CTRL_BORDER             .EQU    254                             ; Controls the screen border
6000-            I    13
6000-            I    14       ; Keyboard row definitions
6000-            I    15       ;                                        Bit     0   1 2 3 4
FEFE-            I    16       KR_SH_ZXCV              .EQU    $FEFE                   ;    SHIFT   Z X C V
FBFE-            I    17       KR_QWERT                .EQU    $FBFE                   ;        Q   W E R T
FDFE-            I    18       KR_ASDFG                .EQU    $FDFE                   ;        A   S D F G
F7FE-            I    19       KR_12345                .EQU    $F7FE                   ;        1   2 3 4 5
EFFE-            I    20       KR_09876                .EQU    $EFFE                   ;        0   9 8 7 6
DFFE-            I    21       KR_POIUY                .EQU    $DFFE                   ;        P   O I U Y
BFFE-            I    22       KR_EN_LKJH              .EQU    $BFFE                   ;    ENTER   L K J H
7FFE-            I    23       KR_SP_SY_MNB    .EQU    $7FFE                   ;    SPACE SYM M N B
6000-                  7                       .IN             attributes.asm  ; Attribute definitions
0000-            I     1       A_BLACK         .EQU    %00000000
0001-            I     2       A_BLUE          .EQU    %00000001
0002-            I     3       A_RED           .EQU    %00000010
0003-            I     4       A_MAGENTA       .EQU    %00000011
0004-            I     5       A_GREEN         .EQU    %00000100
0005-            I     6       A_CYAN          .EQU    %00000101
0006-            I     7       A_YELLOW        .EQU    %00000110
0007-            I     8       A_WHITE         .EQU    %00000111
6000-            I     9
0000-            I    10       A_P_BLACK       .EQU    A_BLACK<<3
0008-            I    11       A_P_BLUE        .EQU    A_BLUE<<3
0010-            I    12       A_P_RED         .EQU    A_RED<<3
0018-            I    13       A_P_MAGENTA     .EQU    A_MAGENTA<<3
0020-            I    14       A_P_GREEN       .EQU    A_GREEN<<3
0028-            I    15       A_P_CYAN        .EQU    A_CYAN<<3
0030-            I    16       A_P_YELLOW      .EQU    A_YELLOW<<3
0038-            I    17       A_P_WHITE       .EQU    A_WHITE<<3
6000-            I    18
0040-            I    19       A_BRIGHT        .EQU    %01000000
0080-            I    20       A_FLASH         .EQU    %10000000
6000-                  8
5CC0-                  9       CUR_X   .EQU    VARS+0                  ; Current cursor location on screen, X
5CC1-                 10       CUR_Y   .EQU    VARS+1                  ;  and Y-location.
5CC2-                 11       LAST_A  .EQU    VARS+2                  ; Last attribute used when clearing screen
5CC3-                 12       CUR_IDX .EQU    VARS+3                  ; Index for title selected
5CC4-                 13       LAST_K  .EQU    VARS+4                  ; Last key value in case we need it
5CC5-                 14       SLOTS   .EQU    VARS+5                  ; Number of slots available
6000-                 15
6000-CD 50 60         16 ( 17) MAIN:   CALL    GET_SLOT_COUNT  ; Calculate SLOTS value
6003-CD E2 62         17 ( 17)                 CALL    RESET_CURSOR    ; Reset cursor
6006-01 00 04         18 ( 10)                 LD              BC,$0400                ; Set up the custom delay routine,
6009-11 00 01         19 ( 10)                 LD              DE,$0100                ;  mainly so that we have time to
600C-CD 33 60         20 ( 17)                 CALL    CUSTOM_DELAY    ;  actually see loader boot screen.
600F-CD 85 60         21 ( 17)                 CALL    SELECTOR                ; Show selection screen
6012-CD B3 61         22 ( 17) .LOOP:  CALL    READ_INPUT              ; Read keyboard
6015-18 FB            23 ( 12)                 JR              .LOOP                   ; Loop forever.
6017-                 24
6017-                 25       LIB_DELAY:
6017-                 26                       .IN             lib_delay.asm
6017-            I     1       ;
6017-            I     2       ; Performs a simple 16-bit delay loop. I've got no idea of the actual timings,
6017-            I     3       ; but it feels like a little over a second.
6017-            I     4       ;
6017-C5          I     5 ( 11) DELAY:  PUSH    BC
6018-D5          I     6 ( 11)                 PUSH    DE
6019-01 00 04    I     7 ( 10)                 LD              BC,$0400
601C-11 00 01    I     8 ( 10)                 LD              DE,$0100
601F-CD 33 60    I     9 ( 17)                 CALL    CUSTOM_DELAY
6022-D1          I    10 ( 10)                 POP             DE
6023-C1          I    11 ( 10)                 POP             BC
6024-C9          I    12 ( 10)                 RET
6025-            I    13
6025-            I    14       KEY_DELAY:
6025-C5          I    15 ( 11)                 PUSH    BC
6026-D5          I    16 ( 11)                 PUSH    DE
6027-01 55 00    I    17 ( 10)                 LD              BC,$0055
602A-11 55 00    I    18 ( 10)                 LD              DE,$0055
602D-CD 33 60    I    19 ( 17)                 CALL    CUSTOM_DELAY
6030-D1          I    20 ( 10)                 POP             DE
6031-C1          I    21 ( 10)                 POP             BC
6032-C9          I    22 ( 10)                 RET
6033-            I    23
6033-            I    24
6033-            I    25       ;
6033-            I    26       ; Custom delay routine, uses just about anything to burn as many cycles as
6033-            I    27       ; possible. Load BC for an outer loop count, DE for an inner loop to control
6033-            I    28       ; how much time this routine uses. For the exact timings, someone'd need to
6033-            I    29       ; count the cycles and divide it by CPU frequency.
6033-            I    30       ;
6033-            I    31       CUSTOM_DELAY:
6033-C5          I    32 ( 11)                 PUSH    BC                              ; Save current registers, mainly because we
6034-D5          I    33 ( 11)                 PUSH    DE                              ; overwrite just about anything and we need
6035-F5          I    34 ( 11)                 PUSH    AF                              ; the calling routines to stay working.
6036-E5          I    35 ( 11)                 PUSH    HL
6037-7A          I    36 (  4)                 LD              A,D                             ; Let's save the starting value of DE - there's
6038-67          I    37 (  4)                 LD              H,A                             ; probably an easier way, but that requires
6039-7B          I    38 (  4)                 LD              A,E                             ; reading.
603A-6F          I    39 (  4)                 LD              L,A
603B-7C          I    40 (  4) .OUTER: LD              A,H                             ; Restore initial DE value
603C-57          I    41 (  4)                 LD              D,A
603D-7D          I    42 (  4)                 LD              A,L
603E-5F          I    43 (  4)                 LD              E,A
603F-1B          I    44 (  6) .INNER: DEC             DE
6040-7A          I    45 (  4)                 LD              A,D                             ; Decrementing DE does not set Z-flag, so we'll
6041-B3          I    46 (  4)                 OR              E                               ;  need to do do this. It's a quirk.
6042-C2 3F 60    I    47 ( 10)                 JP              NZ,.INNER               ; If DE not 0, then do inner loop again.
6045-0B          I    48 (  6)                 DEC             BC                              ; Z-flag. Again.
6046-78          I    49 (  4)                 LD              A,B
6047-B1          I    50 (  4)                 OR              C
6048-C2 3B 60    I    51 ( 10)                 JP              NZ,.OUTER               ; If BE not 0, then do outer loop again.
604B-E1          I    52 ( 10)                 POP             HL                              ; Restore registers that were overwritten.
604C-F1          I    53 ( 10)                 POP             AF
604D-D1          I    54 ( 10)                 POP             DE
604E-C1          I    55 ( 10)                 POP             BC
604F-C9          I    56 ( 10)                 RET
6050-                 27
6050-                 28       ;
6050-                 29       ; Performs an initial calculation to figure out how many slots we need to
6050-                 30       ; display on the screen. There is a maximum of 4 different values to account
6050-                 31       ; for the four chip selects on cartridge port. CUR_IDX will be a value between
6050-                 32       ; 1 and this calculated value.
6050-                 33       ;
6050-                 34       GET_SLOT_COUNT:
6050-21 FC 7F         35 ( 10)                 LD              HL,SLOT_COUNT
6053-06 04            36 (  7)                 LD              B,4
6055-3E 00            37 (  7)                 LD              A,0
6057-86               38 (  7) .NEXT:  ADD             (HL)
6058-23               39 (  6)                 INC             HL
6059-05               40 (  4)                 DEC             B
605A-20 FB            41 ( 7+)                 JR              NZ,.NEXT
605C-32 C5 5C         42 ( 13)                 LD              (SLOTS),A
605F-C9               43 ( 10)                 RET
6060-                 44
6060-                 45       ;
6060-                 46       ; Error screen display.
6060-                 47       ;
6060-3A 08 7B         48 ( 13) ERROR:  LD              A,(S_ERROR)             ; Load error screen attribute definition,
6063-CD D8 63         49 ( 17)                 CALL    CLR_BG                  ;  and clear the screen with it.
6066-                 50
6066-                 51                       ; Outputs the title block
6066-11 94 64         52 ( 10)                 LD              DE,ERR_TITLE
6069-3A 09 7B         53 ( 13)                 LD              A,(S_ERROR_TITLE)
606C-4F               54 (  4)                 LD              C,A
606D-3A 08 7B         55 ( 13)                 LD              A,(S_ERROR)
6070-47               56 (  4)                 LD              B,A
6071-CD E7 60         57 ( 17)                 CALL    TITLE_BOX
6074-                 58
6074-                 59                       ; Error message section
6074-CD 89 63         60 ( 17)                 CALL    SET_FONT2               ; Set regular font
6077-21 0A 00         61 ( 10)                 LD              HL,$000A
607A-CD EB 62         62 ( 17)                 CALL    SET_CURSOR
607D-21 B4 64         63 ( 10)                 LD              HL,ERR_MSG
6080-CD A7 63         64 ( 17)                 CALL    PUTS
6083-18 FE            65 ( 12) .LOOP:  JR              .LOOP                   ; Loop forever.
6085-                 66
6085-                 67       ;
6085-                 68       ; Selection screen display
6085-                 69       ;
6085-                 70       SELECTOR:
6085-3A 01 7B         71 ( 13)                 LD              A,(S_BORDER_M)  ; Get the configured border to use and
6088-D3 FE            72 ( 11)                 OUT             (CTRL_BORDER),A ;  set it before doing anything else.
608A-                 73
608A-3E 01            74 (  7)                 LD              A,1                             ; Initialize title index
608C-32 C3 5C         75 ( 13)                 LD              (CUR_IDX),A             ;  save in RAM for later.
608F-3A 02 7B         76 ( 13)                 LD              A,(S_DEFAULT)   ; Get default attribute value
6092-CD D8 63         77 ( 17)                 CALL    CLR_BG                  ;  and clear screen with it.
6095-                 78
6095-                 79                       ; Outputs the title block
6095-11 00 7C         80 ( 10)                 LD              DE,TITLE0
6098-3A 03 7B         81 ( 13)                 LD              A,(S_TITLE)
609B-47               82 (  4)                 LD              B,A
609C-3A 04 7B         83 ( 13)                 LD              A,(S_NAME)
609F-4F               84 (  4)                 LD              C,A
60A0-CD E7 60         85 ( 17)                 CALL    TITLE_BOX
60A3-                 86
60A3-                 87                       ; Output bank names
60A3-CD 60 61         88 ( 17)                 CALL    UPDATE_TITLES
60A6-                 89
60A6-                 90                       ; Output help section
60A6-3A 07 7B         91 ( 13) .HELP:  LD              A,(S_HELP)
60A9-21 15 00         92 ( 10)                 LD              HL,$0015
60AC-CD EB 62         93 ( 17)                 CALL    SET_CURSOR
60AF-CD 4F 63         94 ( 17)                 CALL    SET_ATTR_ROW
60B2-21 16 00         95 ( 10)                 LD              HL,$0016
60B5-CD EB 62         96 ( 17)                 CALL    SET_CURSOR
60B8-CD 4F 63         97 ( 17)                 CALL    SET_ATTR_ROW
60BB-                 98
60BB-CD 85 63         99 ( 17)                 CALL    SET_FONT1
60BE-21 54 64        100 ( 10)                 LD              HL,MSG_HELP
60C1-CD A7 63        101 ( 17)                 CALL    PUTS
60C4-21 17 00        102 ( 10)                 LD              HL,$0017
60C7-CD EB 62        103 ( 17)                 CALL    SET_CURSOR
60CA-CD 4F 63        104 ( 17)                 CALL    SET_ATTR_ROW
60CD-                105                       ; Print symbols over text as those aren't in the default font.
60CD-11 00 74        106 ( 10)                 LD              DE, FONT_SYMBOLS
60D0-21 16 04        107 ( 10)                 LD              HL,$0416
60D3-CD EB 62        108 ( 17)                 CALL    SET_CURSOR
60D6-3E 00           109 (  7)                 LD              A,0
60D8-CD 66 63        110 ( 17)                 CALL    SET_SYMBOL
60DB-21 16 0B        111 ( 10)                 LD              HL,$0B16
60DE-CD EB 62        112 ( 17)                 CALL    SET_CURSOR
60E1-3E 01           113 (  7)                 LD              A,1
60E3-CD 66 63        114 ( 17)                 CALL    SET_SYMBOL
60E6-C9              115 ( 10)                 RET
60E7-                116
60E7-                117       ;
60E7-                118       ; The title box fiddles around with a lot of symbols to make it look pretty,
60E7-                119       ; so to avoid copying the code we'll generalize it instead.
60E7-                120       ;  DE - Load with screen title address
60E7-                121       ;  B  - Load with title attribute
60E7-                122       ;  C  - Load with cartridge name attribute
60E7-                123       ;
60E7-                124       TITLE_BOX:
60E7-D5              125 ( 11)                 PUSH    DE                              ; Save DE as it points to the title.
60E8-78              126 (  4) .TEXT:  LD              A,B                             ; B holds title attribute
60E9-CD 85 63        127 ( 17)                 CALL    SET_FONT1               ; Set title font
60EC-21 01 00        128 ( 10)                 LD              HL,$0001
60EF-CD EB 62        129 ( 17)                 CALL    SET_CURSOR
60F2-CD 4F 63        130 ( 17)                 CALL    SET_ATTR_ROW
60F5-21 33 64        131 ( 10)                 LD              HL,MSG_TITLE
60F8-CD A7 63        132 ( 17)                 CALL    PUTS
60FB-21 02 00        133 ( 10)                 LD              HL,$0002
60FE-CD EB 62        134 ( 17)                 CALL    SET_CURSOR
6101-79              135 (  4)                 LD              A,C                             ; C holds cartridge name style
6102-CD 4F 63        136 ( 17)                 CALL    SET_ATTR_ROW
6105-E1              137 ( 10)                 POP             HL                              ; Restore previously pushed DE to HL
6106-CD A7 63        138 ( 17)                 CALL    PUTS                    ;  and use it to output the string.
6109-                139
6109-                140       .SYMBOLS:
6109-78              141 (  4)                 LD              A,B
610A-11 00 74        142 ( 10)                 LD              DE,FONT_SYMBOLS ; Set font to point to the symbols
610D-21 00 00        143 ( 10)                 LD              HL,$0000                ; Reset cursor to
6110-CD EB 62        144 ( 17)                 CALL    SET_CURSOR              ;  start of the screen.
6113-CD 4F 63        145 ( 17)                 CALL    SET_ATTR_ROW    ; Update entire row with style.
6116-21 F1 63        146 ( 10)                 LD              HL,MSG_TB_UPPER
6119-CD BA 63        147 ( 17)                 CALL    PUTSS                   ; Print upper title bar
611C-21 03 00        148 ( 10)                 LD              HL,$0003
611F-CD EB 62        149 ( 17)                 CALL    SET_CURSOR
6122-CD 4F 63        150 ( 17)                 CALL    SET_ATTR_ROW
6125-21 12 64        151 ( 10)                 LD              HL,MSG_TB_LOWER ; Print lower title bar
6128-CD BA 63        152 ( 17)                 CALL    PUTSS
612B-21 01 00        153 ( 10)                 LD              HL,$0001                ; Fix left title bar
612E-CD EB 62        154 ( 17)                 CALL    SET_CURSOR
6131-3E 08           155 (  7)                 LD              A,$08
6133-CD 66 63        156 ( 17)                 CALL    SET_SYMBOL
6136-21 02 00        157 ( 10)                 LD              HL,$0002
6139-CD EB 62        158 ( 17)                 CALL    SET_CURSOR
613C-3E 08           159 (  7)                 LD              A,$08
613E-CD 66 63        160 ( 17)                 CALL    SET_SYMBOL
6141-78              161 (  4)                 LD              A,B
6142-CD 48 63        162 ( 17)                 CALL    SET_ATTR
6145-21 01 1F        163 ( 10)                 LD              HL,$1F01                ; Fix right title bar
6148-CD EB 62        164 ( 17)                 CALL    SET_CURSOR
614B-3E 09           165 (  7)                 LD              A,$09
614D-CD 66 63        166 ( 17)                 CALL    SET_SYMBOL
6150-21 02 1F        167 ( 10)                 LD              HL,$1F02
6153-CD EB 62        168 ( 17)                 CALL    SET_CURSOR
6156-3E 09           169 (  7)                 LD              A,$09
6158-CD 66 63        170 ( 17)                 CALL    SET_SYMBOL
615B-78              171 (  4)                 LD              A,B
615C-CD 48 63        172 ( 17)                 CALL    SET_ATTR
615F-C9              173 ( 10) .DONE:  RET
6160-                174
6160-                175       ;
6160-                176       ; Updates the names of titles displayed as well as their attributes. Sort of
6160-                177       ; slow for just marking the active line, but too lazy to build a separate one
6160-                178       ; for just the attributes.
6160-                179       ;
6160-                180       UPDATE_TITLES:
6160-F5              181 ( 11)                 PUSH    AF
6161-C5              182 ( 11)                 PUSH    BC
6162-CD 89 63        183 ( 17)                 CALL    SET_FONT2
6165-3A C5 5C        184 ( 13)                 LD              A,(SLOTS)       ; Load number of titles configured.
6168-47              185 (  4)                 LD              B,A
6169-78              186 (  4) .NEXT:  LD              A,B
616A-CD 73 61        187 ( 17)                 CALL    PRINT_TITLE_N
616D-05              188 (  4)                 DEC             B
616E-20 F9           189 ( 7+)                 JR              NZ,.NEXT
6170-C1              190 ( 10)                 POP             BC
6171-F1              191 ( 10)                 POP             AF
6172-C9              192 ( 10)                 RET
6173-                193
6173-                194       ;
6173-                195       ; Prints bank titles to their corresponding line number, value in A is used as
6173-                196       ; bank index.
6173-                197       ;
6173-                198       PRINT_TITLE_N:
6173-E5              199 ( 11)                 PUSH    HL
6174-F5              200 ( 11)                 PUSH    AF                              ; Store title index
6175-21 00 00        201 ( 10)                 LD              HL,$0000                ; Start calculation at 0,0
6178-C6 04           202 (  7)                 ADD             A,4                             ;  add 4 to get screen line to print to,
617A-6F              203 (  4)                 LD              L,A                             ;  then set this as Y-coordinate.
617B-CD EB 62        204 ( 17)                 CALL    SET_CURSOR              ; Update cursor
617E-F1              205 ( 10)                 POP             AF                              ; Get back the original index
617F-CD 8A 61        206 ( 17)                 CALL    SET_HIGHLIGHT   ; Set background color depending on index
6182-CD A3 61        207 ( 17)                 CALL    GET_TITLE_ADDR  ; Get title string
6185-CD A7 63        208 ( 17)                 CALL    PUTS                    ; Print it.
6188-E1              209 ( 10)                 POP     HL
6189-C9              210 ( 10)                 RET
618A-                211
618A-                212       ;
618A-                213       ; With the currently being processed index in A, compare that to the actually
618A-                214       ; selected bank index. Change attribute data for the entire row to show the
618A-                215       ; difference.
618A-                216       ;
618A-                217       SET_HIGHLIGHT:
618A-D5              218 ( 11)                 PUSH    DE
618B-F5              219 ( 11)                 PUSH    AF
618C-C5              220 ( 11)                 PUSH    BC
618D-47              221 (  4)                 LD              B,A
618E-3A C3 5C        222 ( 13)                 LD              A,(CUR_IDX)
6191-B8              223 (  4)                 CP              A,B                             ; Check if current index?
6192-20 05           224 ( 7+)                 JR              NZ,.INACTIVE    ;  no, jump to inactive
6194-3A 06 7B        225 ( 13)                 LD              A,(S_ACTIVE)    ;  yes, so set attribute style to selected.
6197-18 03           226 ( 12)                 JR              .SET_ROW
6199-                227       .INACTIVE:
6199-3A 05 7B        228 ( 13)                 LD              A,(S_INACTIVE)
619C-                229       .SET_ROW:
619C-CD 4F 63        230 ( 17)                 CALL    SET_ATTR_ROW
619F-C1              231 ( 10)                 POP             BC
61A0-F1              232 ( 10)                 POP             AF
61A1-D1              233 ( 10)                 POP             DE
61A2-C9              234 ( 10)                 RET
61A3-                235
61A3-                236       ;
61A3-                237       ; Get the memory address of the bank title, as indicated by the value in A.
61A3-                238       ; This works based on the fact that we chose to use 32 bytes for each of the
61A3-                239       ; title strings (this includes $00 termination, so 31 characters max for
61A3-                240       ; each of them).
61A3-                241       ;
61A3-                242       GET_TITLE_ADDR:
61A3-F5              243 ( 11)                 PUSH    AF
61A4-0F              244 (  4)                 RRCA                                    ; Multiply by 32
61A5-0F              245 (  4)                 RRCA
61A6-0F              246 (  4)                 RRCA
61A7-6F              247 (  4)                 LD              L,A                             ; Store as low byte
61A8-E6 03           248 (  7)                 AND             3                               ; Mask bits for high byte
61AA-C6 7C           249 (  7)                 ADD             A,$7C                   ;  and with first string address ($7C00)
61AC-67              250 (  4)                 LD              H,A                             ; High byte done.
61AD-7D              251 (  4)                 LD              A,L                             ; Get back x*32
61AE-E6 E0           252 (  7)                 AND             $E0
61B0-6F              253 (  4)                 LD              L,A                             ; Put in L.
61B1-F1              254 ( 10)                 POP             AF
61B2-C9              255 ( 10)                 RET
61B3-                256       ;
61B3-                257       ; Initial routine for handle keyboard input.
61B3-                258       ;
61B3-                259       READ_INPUT:
61B3-E5              260 ( 11)                 PUSH    HL
61B4-CD D6 61        261 ( 17) .JOY1:  CALL    READ_JOY1               ; Read joystick 1, sets Z if no keys pressed.
61B7-28 02           262 ( 7+)                 JR              Z,.JOY2                 ;  Check next joystick on no keys in use.
61B9-18 14           263 ( 12)                 JR              .DONE                   ;  Done for now if we've detected a key.
61BB-CD 12 62        264 ( 17) .JOY2:  CALL    READ_JOY2               ; Read joystick 1, sets Z if no keys pressed.
61BE-28 02           265 ( 7+)                 JR              Z,.CHK_Q                ;  No keys pressed, so we go check Q instead.
61C0-18 0D           266 ( 12)                 JR              .DONE                   ;  Done for now if we've detected a key.
61C2-01 FE FB        267 ( 10) .CHK_Q: LD              BC,KR_QWERT             ; Check for Q key
61C5-CD D1 61        268 ( 17)                 CALL    READ_ROW                ; Read corresponding keyboard row.
61C8-E6 01           269 (  7)                 AND             %00000001               ; Is Q pressed?
61CA-20 03           270 ( 7+)                 JR              NZ,.DONE                ;  No, then we are done.
61CC-C3 DC 62        271 ( 10)                 JP              START_BASIC             ;  Yes, then we go start ZX Basic.
61CF-E1              272 ( 10) .DONE:  POP             HL
61D0-C9              273 ( 10)                 RET
61D1-                274
61D1-                275       ;
61D1-                276       ; Read keyboard row as indicated by the BC registers, value
61D1-                277       ; will be put in A. Note that due to Z80 quirkiness, the
61D1-                278       ; entire BC value (address) will be put on the address bus.
61D1-                279       ;
61D1-                280       READ_ROW:
61D1-ED 78           281 ( 12)                 IN              A,(C)
61D3-E6 1F           282 (  7)                 AND             %00011111               ; Mask out floating bits
61D5-C9              283 ( 10)                 RET
61D6-                284
61D6-                285       ;
61D6-                286       ; Handles a detected key press, but we delay exectution until
61D6-                287       ; we've detected the release of the key (mostly to avoid having to
61D6-                288       ; deal with key repeat delays).
61D6-                289       ;
61D6-                290       READ_JOY1:
61D6-C5              291 ( 11)                 PUSH    BC
61D7-01 FE EF        292 ( 10)                 LD              BC,KR_09876             ; Keys 6 through 9
61DA-CD D1 61        293 ( 17)                 CALL    READ_ROW                ; Read row,
61DD-FE 1F           294 (  7)                 CP              %00011111               ;  check if no keys are pressed?
61DF-28 2D           295 ( 7+)                 JR              Z,.DONE                 ; Yes, so we go check Q instead.
61E1-                296
61E1-D5              297 ( 11)                 PUSH    DE
61E2-32 C4 5C        298 ( 13)                 LD              (LAST_K),A              ; Store key for later
61E5-CD 25 60        299 ( 17) .AGAIN: CALL    KEY_DELAY
61E8-CD D1 61        300 ( 17)                 CALL    READ_ROW                ; Read row again, and then
61EB-FE 1F           301 (  7)                 CP              %00011111               ;  check if no keys are pressed?
61ED-28 02           302 ( 7+)                 JR              Z,.RELEASED             ; Yes, so go do something.
61EF-18 F4           303 ( 12)                 JR              .AGAIN
61F1-                304       .RELEASED:
61F1-D1              305 ( 10)                 POP             DE
61F2-3A C4 5C        306 ( 13)                 LD              A,(LAST_K)              ; Read it back again.
61F5-FE 1D           307 (  7) .CHK_9: CP              %00011101               ; Bit 1 is zero for UP
61F7-20 05           308 ( 7+)                 JR              NZ,.CHK_8               ; Next key, unless we have a match.
61F9-CD 4C 62        309 ( 17)                 CALL    MOVE_UP
61FC-18 10           310 ( 12)                 JR              .DONE
61FE-FE 1B           311 (  7) .CHK_8: CP              %00011011               ; Bit 2 is zero for DOWN
6200-20 05           312 ( 7+)                 JR              NZ,.CHK_0               ; Next key, unless we have a match.
6202-CD 5D 62        313 ( 17)                 CALL    MOVE_DOWN
6205-18 07           314 ( 12)                 JR              .DONE
6207-FE 1E           315 (  7) .CHK_0: CP              %00011110               ; Bit 0 is zero for FIRE
6209-20 03           316 ( 7+)                 JR              NZ,.DONE                ; Done checking, unless we have a match.
620B-CD 73 62        317 ( 17)                 CALL    PRESS_FIRE
620E-C1              318 ( 10) .DONE:  POP             BC
620F-FE 1F           319 (  7)                 CP              %00011111               ; Update Z-flag to indicate no key
6211-C9              320 ( 10)                 RET
6212-                321
6212-                322       ;
6212-                323       ; Handles a detected key press, but we delay exectution until
6212-                324       ; we've detected the release of the key (mostly to avoid having to
6212-                325       ; deal with key repeat delays).
6212-                326       ;
6212-                327       READ_JOY2:
6212-C5              328 ( 11)                 PUSH    BC
6213-01 FE F7        329 ( 10)                 LD              BC,KR_12345             ; Keys 1 through 5
6216-CD D1 61        330 ( 17)                 CALL    READ_ROW                ; Read row,
6219-FE 1F           331 (  7)                 CP              %00011111               ;  check if no keys are pressed?
621B-28 2D           332 ( 7+)                 JR              Z,.DONE                 ; Yes, so we go check Q instead.
621D-                333
621D-D5              334 ( 11)                 PUSH    DE
621E-32 C4 5C        335 ( 13)                 LD              (LAST_K),A              ; Store key for later
6221-CD 25 60        336 ( 17) .AGAIN: CALL    KEY_DELAY
6224-CD D1 61        337 ( 17)                 CALL    READ_ROW                ; Read row again, and then
6227-FE 1F           338 (  7)                 CP              %00011111               ;  check if all keys released.
6229-28 02           339 ( 7+)                 JR              Z,.RELEASED             ; Yes, so go do something.
622B-18 F4           340 ( 12)                 JR              .AGAIN
622D-                341       .RELEASED:
622D-D1              342 ( 10)                 POP             DE
622E-3A C4 5C        343 ( 13)                 LD              A,(LAST_K)              ; Read it back again.
6231-FE 17           344 (  7) .CHK_4: CP              %00010111               ; Bit 3 is zero for UP
6233-20 05           345 ( 7+)                 JR              NZ,.CHK_3               ; Next key, unless we have a match.
6235-CD 4C 62        346 ( 17)                 CALL    MOVE_UP
6238-18 10           347 ( 12)                 JR              .DONE
623A-FE 1B           348 (  7) .CHK_3: CP              %00011011               ; Bit 2 is zero for DOWN
623C-20 05           349 ( 7+)                 JR              NZ,.CHK_5               ; Next key, unless we have a match.
623E-CD 5D 62        350 ( 17)                 CALL    MOVE_DOWN
6241-18 07           351 ( 12)                 JR              .DONE
6243-FE 0F           352 (  7) .CHK_5: CP              %00001111               ; Bit 4 is zero for FIRE
6245-20 03           353 ( 7+)                 JR              NZ,.DONE                ; Done checking, unless we have a match.
6247-CD 73 62        354 ( 17)                 CALL    PRESS_FIRE
624A-C1              355 ( 10) .DONE:  POP             BC
624B-C9              356 ( 10)                 RET
624C-                357
624C-                358       ;
624C-                359       ; Move selection up, decrementing the index as we go. The code ensures that
624C-                360       ; we don't go past the minimum value of of 1 (bank 0 is this program).
624C-                361       ;
624C-                362       MOVE_UP:
624C-F5              363 ( 11)                 PUSH    AF
624D-3A C3 5C        364 ( 13)                 LD              A,(CUR_IDX)             ; Load current index number.
6250-                365
6250-FE 01           366 (  7)                 CP              1                               ; Already at minimum index?
6252-28 04           367 ( 7+)                 JR              Z,.DONE                 ; Yes, then we are done.
6254-3D              368 (  4)                 DEC             A                               ; No, so let's bump it up one position.
6255-32 C3 5C        369 ( 13)                 LD              (CUR_IDX),A
6258-CD 60 61        370 ( 17) .DONE:  CALL    UPDATE_TITLES   ; Update the titles with highlight.
625B-F1              371 ( 10)                 POP             AF
625C-C9              372 ( 10)                 RET
625D-                373
625D-                374       ;
625D-                375       ; Move selection down, incrementing the index as far as we can go. This value
625D-                376       ; comes from the SLOTS variable, initially calculated from the values entered
625D-                377       ; in NUM_TITLES at the end of the image. We need to do this so that we can't
625D-                378       ; go past the size of the actual EEPROM.
625D-                379       ;
625D-                380       MOVE_DOWN:
625D-F5              381 ( 11)                 PUSH    AF
625E-C5              382 ( 11)                 PUSH    BC
625F-3A C5 5C        383 ( 13)                 LD              A,(SLOTS)               ; Get the maximum number we can have,
6262-47              384 (  4)                 LD              B,A                             ;  save it in C for later comparison.
6263-3A C3 5C        385 ( 13)                 LD              A,(CUR_IDX)             ; Load current index number.
6266-                386
6266-B8              387 (  4)                 CP              B                               ; Already at maximum index?
6267-28 04           388 ( 7+)                 JR              Z,.DONE                 ; Yes, then we are done.
6269-3C              389 (  4)                 INC             A                               ; No, so let's bump it up one position.
626A-32 C3 5C        390 ( 13)                 LD              (CUR_IDX),A
626D-CD 60 61        391 ( 17) .DONE:  CALL    UPDATE_TITLES   ; Update the titles with highlight.
6270-C1              392 ( 10)                 POP             BC
6271-F1              393 ( 10)                 POP             AF
6272-C9              394 ( 10)                 RET
6273-                395
6273-                396       ;
6273-                397       ; The fire button has been pushed, so we'll attempt to perform bank switching.
6273-                398       ;
6273-                399       PRESS_FIRE:
6273-F5              400 ( 11)                 PUSH    AF
6274-C5              401 ( 11)                 PUSH    BC
6275-E5              402 ( 11)                 PUSH    HL
6276-D5              403 ( 11)                 PUSH    DE
6277-                404
6277-CD 91 62        405 ( 17)                 CALL    GET_BANK_IDENTIFIER
627A-7C              406 (  4)                 LD              A,H                             ; Bank identifier in A
627B-45              407 (  4)                 LD              B,L                             ; Chip identifier in B
627C-CB 10           408 (  8)                 RL              B                               ; Shift CS value into correct position, these
627E-CB 10           409 (  8)                 RL              B                               ;  should be bit 6 and 7 on the bank switching
6280-CB 10           410 (  8)                 RL              B                               ;  register.
6282-CB 10           411 (  8)                 RL              B
6284-CB 10           412 (  8)                 RL              B
6286-CB 10           413 (  8)                 RL              B
6288-80              414 (  4)                 ADD             B                               ; Add slot number to it
6289-                415
6289-CD BE 62        416 ( 17)                 CALL    SET_BANK
628C-                417
628C-D1              418 ( 10)                 POP             DE
628D-E1              419 ( 10)                 POP             HL
628E-C1              420 ( 10)                 POP             BC
628F-F1              421 ( 10)                 POP             AF
6290-C9              422 ( 10)                 RET                                             ; We should never be able to get here.
6291-                423
6291-                424       ;
6291-                425       ; Converts the current slot index into a value suitable for use with the
6291-                426       ; bank switching scheme, this is mostly complicated due to the four counters
6291-                427       ; used. On return H will hold bank value, L will indicate the chip identifier.
6291-                428       ;
6291-                429       GET_BANK_IDENTIFIER:
6291-F5              430 ( 11)                 PUSH    AF
6292-C5              431 ( 11)                 PUSH    BC
6293-D5              432 ( 11)                 PUSH    DE
6294-                433
6294-21 FC 7F        434 ( 10)                 LD              HL,SLOT_COUNT
6297-0E 04           435 (  7)                 LD              C,4
6299-3A C3 5C        436 ( 13)                 LD              A,(CUR_IDX)
629C-57              437 (  4)                 LD              D,A
629D-3E 00           438 (  7)                 LD              A,0
629F-1E 00           439 (  7)                 LD              E,0
62A1-                440       .NEXT_CHIP:
62A1-46              441 (  7)                 LD              B,(HL)
62A2-1E 00           442 (  7)                 LD              E,0
62A4-1C              443 (  4) .NEXT:  INC             E
62A5-3C              444 (  4)                 INC     A
62A6-BA              445 (  4)                 CP              D
62A7-28 07           446 ( 7+)                 JR              Z,.DONE
62A9-                447
62A9-05              448 (  4)                 DEC             B
62AA-20 F8           449 ( 7+)                 JR              NZ,.NEXT
62AC-                450
62AC-23              451 (  6)                 INC             HL
62AD-0D              452 (  4)                 DEC             C
62AE-20 F1           453 ( 7+)                 JR              NZ,.NEXT_CHIP
62B0-                454
62B0-                455       .DONE:
62B0-3E 04           456 (  7)                 LD              A,4
62B2-91              457 (  4)                 SUB             C
62B3-47              458 (  4)                 LD              B,A
62B4-20 01           459 ( 7+)                 JR              NZ,.OFFSET_LOADER
62B6-1C              460 (  4)                 INC             E
62B7-                461       .OFFSET_LOADER:
62B7-1D              462 (  4)                 DEC             E
62B8-63              463 (  4)                 LD              H,E
62B9-6F              464 (  4)                 LD              L,A
62BA-                465
62BA-D1              466 ( 10)                 POP             DE
62BB-C1              467 ( 10)                 POP             BC
62BC-F1              468 ( 10)                 POP             AF
62BD-C9              469 ( 10)                 RET
62BE-                470
62BE-                471       ;
62BE-                472       ; Configures bank switching according to value in A. Before restarting at
62BE-                473       ; $0000 to start the bank that has been switched in, we'll try to ensure
62BE-                474       ; that the bank was actually switched - this is done by looking for a text
62BE-                475       ; signature at $0400. After switching the first two bytes probably shouldn't
62BE-                476       ; match 'Z' and 'X'.
62BE-                477       ;
62BE-                478       SET_BANK:
62BE-F3              479 (  4)                 DI                                              ; Disable interrupts
62BF-0E 3F           480 (  7)                 LD              C,CTRL_LED              ; Controls LEDs found on ZX Diagnostic 2.021
62C1-ED 79           481 ( 12)                 OUT             (C),A                   ;  so let's just write the value to it.
62C3-0E 1F           482 (  7)                 LD              C,CTRL_BANK             ; Port used for controlling the bank switching
62C5-ED 79           483 ( 12)                 OUT             (C),A                   ;  we write the same value.
62C7-21 00 04        484 ( 10) .CHECK: LD              HL,SIGNATURE    ; Banks should now have been switched around,
62CA-7E              485 (  7)                 LD              A,(HL)                  ;  but in order to make sure we'll check.
62CB-FE 5A           486 (  7)                 CP              'Z'
62CD-20 09           487 ( 7+)                 JR              NZ,.OK
62CF-23              488 (  6)                 INC             HL
62D0-7E              489 (  7)                 LD              A,(HL)
62D1-FE 58           490 (  7)                 CP              'X'
62D3-20 03           491 ( 7+)                 JR              NZ,.OK
62D5-C3 60 60        492 ( 10) .ERROR: JP              ERROR                   ; Jump out of main loop and set error screen.
62D8-C3 00 00        493 ( 10) .OK:    JP              $0000                   ; Looks good, so we'll just start from the bank.
62DB-C9              494 ( 10)                 RET                                             ; We should never be able to get here.
62DC-                495
62DC-                496       ;
62DC-                497       ; Start ZX Basic. This is done by attempting to deactivate the bank switching
62DC-                498       ; hardware, then before restarting at $0000 a check will be made to see that
62DC-                499       ; the loader ROM has disappeared.
62DC-                500       ;
62DC-                501       START_BASIC:
62DC-3E 20           502 (  7)                 LD              A,%00100000             ; Bit 5 disables bank switching.
62DE-CD BE 62        503 ( 17)                 CALL    SET_BANK                ; Try to do it.
62E1-C9              504 ( 10)                 RET                                             ; We should never be able to get here.
62E2-                505
62E2-                506       ;
62E2-                507       ; Reset cursor position.
62E2-                508       ;
62E2-                509       RESET_CURSOR:
62E2-3E 00           510 (  7)                 LD              A,0
62E4-32 C0 5C        511 ( 13)                 LD              (CUR_X),A
62E7-32 C1 5C        512 ( 13)                 LD              (CUR_Y),A
62EA-C9              513 ( 10)                 RET
62EB-                514
62EB-                515       ;
62EB-                516       ; Set cursor position, HL register is treated as X,Y character coordinates.
62EB-                517       ; Example:
62EB-                518       ;               LD A,$0102 will set X=1 and Y=2
62EB-                519       ;
62EB-                520       SET_CURSOR:
62EB-F5              521 ( 11)                 PUSH    AF
62EC-7C              522 (  4)                 LD              A,H
62ED-32 C0 5C        523 ( 13)                 LD              (CUR_X),A
62F0-7D              524 (  4)                 LD              A,L
62F1-32 C1 5C        525 ( 13)                 LD              (CUR_Y),A
62F4-F1              526 ( 10)                 POP             AF
62F5-C9              527 ( 10)                 RET
62F6-                528
62F6-                529       ;
62F6-                530       ; Loads cursor into HL register, this moves data in exactly the opposite
62F6-                531       ; way as SET_CURSOR.
62F6-                532       ;
62F6-                533       GET_CURSOR:
62F6-F5              534 ( 11)                 PUSH    AF
62F7-3A C0 5C        535 ( 13)                 LD              A,(CUR_X)
62FA-67              536 (  4)                 LD              H,A
62FB-3A C1 5C        537 ( 13)                 LD              A,(CUR_Y)
62FE-6F              538 (  4)                 LD              L,A
62FF-F1              539 ( 10)                 POP             AF
6300-C9              540 ( 10)                 RET
6301-                541
6301-                542       ;
6301-                543       ; Increment cursor position. While the screen attribute memory is organized
6301-                544       ; as expected, the RAM used for the pixel data is not - so we need to track
6301-                545       ; when we cross over from one line into the next.
6301-                546       ;
6301-                547       INC_CURSOR:
6301-F5              548 ( 11)                 PUSH    AF                              ; Save AF for when I forget it
6302-3A C0 5C        549 ( 13)                 LD              A,(CUR_X)
6305-FE 1F           550 (  7)                 CP              32-1                    ; Check if in last column
6307-38 07           551 ( 7+)                 JR              C,.INC_X                ; no, just increment X
6309-3E 00           552 (  7)                 LD              A,0                             ; yes, so we:
630B-32 C0 5C        553 ( 13)                 LD              (CUR_X),A               ;   reset X
630E-18 09           554 ( 12)                 JR              .INC_Y                  ;   increment Y
6310-3A C0 5C        555 ( 13) .INC_X: LD              A,(CUR_X)
6313-3C              556 (  4)                 INC             A
6314-32 C0 5C        557 ( 13)                 LD              (CUR_X),A
6317-18 15           558 ( 12)                 JR              .DONE
6319-3A C1 5C        559 ( 13) .INC_Y: LD              A,(CUR_Y)
631C-FE 17           560 (  7)                 CP              24-1                    ; Check if on last row
631E-38 07           561 ( 7+)                 JR              C,.NXT_Y                ; no, just go to the next
6320-3E 00           562 (  7)                 LD              A,0                             ;   yes, so we:
6322-32 C1 5C        563 ( 13)                 LD              (CUR_Y),A               ;   reset Y
6325-18 07           564 ( 12)                 JR              .DONE                   ;   and we are done.
6327-3A C1 5C        565 ( 13) .NXT_Y: LD              A,(CUR_Y)
632A-3C              566 (  4)                 INC             A
632B-32 C1 5C        567 ( 13)                 LD              (CUR_Y),A
632E-F1              568 ( 10) .DONE:  POP             AF                              ; Restore AF
632F-C9              569 ( 10)                 RET
6330-                570
6330-                571       ;
6330-                572       ; Get the memory address for the attribute as indicated by the cursor.
6330-                573       ; At the end, HL should hold an address from $5800 and upwards.
6330-                574       ;
6330-                575       GET_ATTR_ADDR:
6330-F5              576 ( 11)                 PUSH    AF
6331-3A C1 5C        577 ( 13)                 LD              A,(CUR_Y)               ; X position
6334-0F              578 (  4)                 RRCA                                    ; Multiply by 32
6335-0F              579 (  4)                 RRCA
6336-0F              580 (  4)                 RRCA
6337-6F              581 (  4)                 LD              L,A                             ; Store as low byte
6338-E6 03           582 (  7)                 AND             3                               ; Mask bits for high byte
633A-C6 58           583 (  7)                 ADD             A,$58                   ; And with start of attribute address
633C-67              584 (  4)                 LD              H,A                             ; High byte done.
633D-7D              585 (  4)                 LD              A,L                             ; Get back x*32
633E-E6 E0           586 (  7)                 AND             $E0
6340-6F              587 (  4)                 LD              L,A                             ; Put in L.
6341-3A C0 5C        588 ( 13)                 LD              A,(CUR_X)               ; Get row start
6344-85              589 (  4)                 ADD             A,L                             ; Add to low byte
6345-6F              590 (  4)                 LD              L,A
6346-F1              591 ( 10)                 POP             AF
6347-C9              592 ( 10)                 RET
6348-                593
6348-                594       ;
6348-                595       ; Set attributes for the block currently indicated by the
6348-                596       ; cursor.
6348-                597       ;
6348-                598       SET_ATTR:
6348-E5              599 ( 11)                 PUSH    HL
6349-CD 30 63        600 ( 17)                 CALL    GET_ATTR_ADDR
634C-77              601 (  7)                 LD              (HL),A
634D-E1              602 ( 10)                 POP             HL
634E-C9              603 ( 10)                 RET
634F-                604
634F-                605       ;
634F-                606       ; Set the attributes for a row of screen memory, automatically setting the
634F-                607       ; cursor location to the beginning of the row. Does not increment after
634F-                608       ; every character as we're not actually printing data.
634F-                609       ;
634F-                610       SET_ATTR_ROW:
634F-E5              611 ( 11)                 PUSH    HL
6350-C5              612 ( 11)                 PUSH    BC
6351-CD 30 63        613 ( 17)                 CALL    GET_ATTR_ADDR
6354-                614
6354-06 20           615 (  7)                 LD              B,32
6356-77              616 (  7) .NEXT:  LD              (HL),A
6357-23              617 (  6)                 INC             HL
6358-05              618 (  4)                 DEC             B
6359-20 FB           619 ( 7+)                 JR              NZ,.NEXT
635B-C1              620 ( 10)                 POP             BC
635C-E1              621 ( 10)                 POP             HL
635D-C9              622 ( 10)                 RET
635E-                623
635E-                624       ;
635E-                625       ; Output character to the screen. Given that the assembled sources will be
635E-                626       ; expected to be ASCII, we'll need to subtract 32 from the value.
635E-                627       ;
635E-                628       SET_CHAR:
635E-F5              629 ( 11)                 PUSH    AF
635F-D6 20           630 (  7)                 SUB             32                              ; Subtract 32 from ASCII to get font offset
6361-CD 66 63        631 ( 17)                 CALL    SET_SYMBOL
6364-F1              632 ( 10)                 POP             AF
6365-C9              633 ( 10)                 RET
6366-                634
6366-                635       ;
6366-                636       ; Outputs character with A specifying index into font data, note that DE is
6366-                637       ; expected to hold the memory reference for the font used.
6366-                638       ;
6366-                639       SET_SYMBOL:
6366-C5              640 ( 11)                 PUSH    BC
6367-D5              641 ( 11)                 PUSH    DE
6368-E5              642 ( 11)                 PUSH    HL
6369-CD 8D 63        643 ( 17)                 CALL    GET_SCREEN_ADDR ; Get screen address for cursor location
636C-06 00           644 (  7)                 LD              B,0                             ; Find FONT_DATA character index
636E-4F              645 (  4)                 LD              C,A
636F-                646
636F-CB 21           647 (  8)                 SLA             C
6371-CB 10           648 (  8)                 RL              B
6373-CB 21           649 (  8)                 SLA             C
6375-CB 10           650 (  8)                 RL              B
6377-CB 21           651 (  8)                 SLA             C
6379-CB 10           652 (  8)                 RL              B
637B-                653
637B-EB              654 (  4)                 EX              DE, HL
637C-09              655 ( 11)                 ADD     HL, BC
637D-EB              656 (  4)                 EX              DE, HL
637E-CD CD 63        657 ( 17)                 CALL    SET_CHAR_PIXELS ; Output pixels to screen memory
6381-E1              658 ( 10)                 POP     HL
6382-D1              659 ( 10)                 POP             DE
6383-C1              660 ( 10)                 POP             BC
6384-C9              661 ( 10)                 RET
6385-                662
6385-                663       SET_FONT1:
6385-11 00 75        664 ( 10)                 LD              DE,FONT1                ; Start of font data
6388-C9              665 ( 10)                 RET
6389-                666
6389-                667       SET_FONT2:
6389-11 00 78        668 ( 10)                 LD              DE,FONT2
638C-C9              669 ( 10)                 RET
638D-                670
638D-                671       ;
638D-                672       ; Get the memory address for the character as indicated by the cursor,
638D-                673       ; the location in screen memory will be left in HL (from $4000 to $57FF).
638D-                674       ;
638D-                675       GET_SCREEN_ADDR:
638D-F5              676 ( 11)                 PUSH    AF
638E-3A C0 5C        677 ( 13)                 LD              A,(CUR_X)
6391-6F              678 (  4)                 LD              L,A
6392-                679
6392-3A C1 5C        680 ( 13)                 LD              A,(CUR_Y)
6395-E6 07           681 (  7)                 AND     %00000111
6397-1F              682 (  4)                 RRA
6398-1F              683 (  4)                 RRA
6399-1F              684 (  4)                 RRA
639A-1F              685 (  4)                 RRA
639B-B5              686 (  4)                 OR              L
639C-6F              687 (  4)                 LD              L,A
639D-3A C1 5C        688 ( 13)                 LD              A,(CUR_Y)
63A0-E6 18           689 (  7)                 AND     %00011000
63A2-F6 40           690 (  7)                 OR              /SCREEN                 ; Screen address HI byte
63A4-67              691 (  4)                 LD              H,A
63A5-                692
63A5-F1              693 ( 10)                 POP             AF
63A6-C9              694 ( 10)                 RET
63A7-                695
63A7-                696       ;
63A7-                697       ; Print string to the current cursor position, incrementing for each character
63A7-                698       ; that is "printed" to the screen memory.
63A7-                699       ;
63A7-E5              700 ( 11) PUTS:   PUSH    HL
63A8-F5              701 ( 11)                 PUSH    AF
63A9-7E              702 (  7) .NEXT:  LD              A,(HL)
63AA-B7              703 (  4)                 OR              A                               ; OR with itself to update the Z-flag.
63AB-28 0A           704 ( 7+)                 JR              Z,.DONE                 ; Done if we found byte that is $00
63AD-CD 5E 63        705 ( 17)                 CALL    SET_CHAR                ; Output character to cursor location
63B0-CD 01 63        706 ( 17)                 CALL    INC_CURSOR              ; Increment cursor to next position
63B3-23              707 (  6)                 INC             HL                              ; Next character
63B4-C3 A9 63        708 ( 10)                 JP              .NEXT
63B7-F1              709 ( 10) .DONE:  POP             AF
63B8-E1              710 ( 10)                 POP             HL
63B9-C9              711 ( 10)                 RET
63BA-                712
63BA-                713       ;
63BA-                714       ; Same as above except that we output symbols directly instead of translating
63BA-                715       ; ASCII characters (that way we don't have to hardcode symbols at +32).
63BA-                716       ;
63BA-E5              717 ( 11) PUTSS:  PUSH    HL
63BB-F5              718 ( 11)                 PUSH    AF
63BC-7E              719 (  7) .NEXT:  LD              A,(HL)
63BD-B7              720 (  4)                 OR              A                               ; OR with itself to update the Z-flag.
63BE-28 0A           721 ( 7+)                 JR              Z,.DONE                 ; Done if we found byte that is $00
63C0-CD 66 63        722 ( 17)                 CALL    SET_SYMBOL              ; Output character to cursor location
63C3-CD 01 63        723 ( 17)                 CALL    INC_CURSOR              ; Increment cursor to next position
63C6-23              724 (  6)                 INC             HL                              ; Next character
63C7-C3 BC 63        725 ( 10)                 JP              .NEXT
63CA-F1              726 ( 10) .DONE:  POP             AF
63CB-E1              727 ( 10)                 POP             HL
63CC-C9              728 ( 10)                 RET
63CD-                729
63CD-                730       ;
63CD-                731       ; Output character data into screen memory, these are 8x8 pixels - meaning
63CD-                732       ; we'll need to update eight different lines on the screen.
63CD-                733       ;
63CD-                734       SET_CHAR_PIXELS:
63CD-06 08           735 (  7)                 LD              B,8                             ; 8 lines per character
63CF-1A              736 (  7) .NEXT:  LD              A,(DE)                  ; Load character byte data
63D0-77              737 (  7)                 LD              (HL),A                  ; Store byte data in screen memory
63D1-13              738 (  6)                 INC             DE                              ; Next character byte
63D2-24              739 (  4)                 INC             H                               ; Screen line start every $100, so we do that
63D3-10 FA           740 ( 8+)                 DJNZ    .NEXT                   ; Loop unless B reached 0.
63D5-C9              741 ( 10)                 RET
63D6-                742
63D6-                743       ;
63D6-                744       ; Clear the entire screen, value in A is used to initialize the corresponding
63D6-                745       ; attribute bytes (when CLR_BG is called directly). The byte must have the
63D6-                746       ; following composition:
63D6-                747       ;       bit 0 (ink bit 0)
63D6-                748       ;           1 (        1)
63D6-                749       ;           2 (        2)
63D6-                750       ;       bit 3 (paper bit 0)
63D6-                751       ;           4 (          1)
63D6-                752       ;       5 (          2)
63D6-                753       ;   bit 6 (bright mode)
63D6-                754       ;   bit 7 (flash mode)
63D6-                755       ;
63D6-3E 00           756 (  7) CLEAR:  LD              A,0
63D8-F5              757 ( 11) CLR_BG: PUSH    AF
63D9-32 C2 5C        758 ( 13)                 LD              (LAST_A),A              ; Save attribute value for later
63DC-21 00 40        759 ( 10)                 LD              HL,SCREEN               ; Screen memory start
63DF-11 01 40        760 ( 10)                 LD              DE,SCREEN+1
63E2-01 00 18        761 ( 10)                 LD              BC,SZ_SCRN
63E5-36 00           762 ( 10)                 LD              (HL),0
63E7-ED B0           763 (16+)                 LDIR                                    ; Loop until we've written SZ_SCRN bytes
63E9-01 FF 02        764 ( 10)                 LD              BC,SZ_ATTR-1
63EC-77              765 (  7)                 LD              (HL),A
63ED-ED B0           766 (16+)                 LDIR                                    ; Loop until we've written all attributes
63EF-F1              767 ( 10)                 POP             AF
63F0-C9              768 ( 10)                 RET
63F1-                769
63F1-                770       MSG_TB_UPPER:
63F1-02 03 03 03 
     03 03 03 03 
     03 03 03 03 
     03 03 03        771                       .DB             $02,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03
6400-03 03 03 03 
     03 03 03 03 
     03 03 03 03 
     03 03 03        772                       .DB             $03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03,$03
640F-03 04 00        773                       .DB             $03,$04,$00
6412-                774       MSG_TB_LOWER:
6412-06 05 05 05 
     05 05 05 05 
     05 05 05 05 
     05 05 05        775                       .DB             $06,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05
6421-05 05 05 05 
     05 05 05 05 
     05 05 05 05 
     05 05 05        776                       .DB             $05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05,$05
6430-05 07 00        777                       .DB             $05,$07,$00
6433-                778       MSG_TITLE:
6433-20 20 20 20 
     20 20 20 5A 
     58 20 49 4E 
     54 45 52 46 
     41 43 45 20 
     32 2E 30 32 
     31 20 20 20 
     20 20 20 20 
     00              779                       .AZ             "       ZX INTERFACE 2.021       "
6454-                780       MSG_HELP:
6454-20 20 20 28 
     3F 20 3D 20 
     38 20 20 3F 
     20 3D 20 39 
     20 20 53 54 
     41 52 54 20 
     3D 20 30 29 
     20 20 20 20     781                       .AS             "   (? = 8  ? = 9  START = 0)    "
6474-20 20 20 20 
     20 20 20 20 
     28 51 20 3D 
     20 5A 58 20 
     42 61 73 69 
     63 29 20 20 
     20 20 20 20 
     20 20 20 00     782                       .AZ             "        (Q = ZX Basic)         "
6494-                783       ERR_TITLE:
6494-20 20 20 20 
     20 20 20 20 
     20 20 20 20 
     20 45 52 52 
     4F 52 20 20 
     20 20 20 20 
     20 20 20 20 
     20 20 20 00     784                       .AZ             "             ERROR             "
64B4-                785       ERR_MSG:
64B4-20 22 43 61 
     72 74 72 69 
     64 67 65 20 
     62 61 6E 6B 
     20 6E 6F 74 
     20 73 77 69 
     74 63 68 65 
     64 20 6F 75 
     74 20 61 73 
     20 65 78 70 
     65 63 74 65 
     64 2E 20 53 
     6F 66 74 77 
     61 72 65 20 
     66 6F 72        786                       .AS             " \"Cartridge bank not switched out as expected. Software for"
64EF-20 75 73 65 
     20 77 69 74 
     68 20 5A 58 
     20 49 6E 74 
     65 72 66 61 
     63 65 20 32 
     2E 30 32 31 
     20 6F 72 20 
     63 6F 6D 70 
     61 74 69 62 
     6C 65 20 68 
     61 72 64 77 
     61 72 65 2E 
     22 00           787                       .AZ             " use with ZX Interface 2.021 or compatible hardware.\""
6525-                788
7400                789                       .NO             $7400
7400-                790       FONT_SYMBOLS:
7400-                791                       .IN             font_symbols.asm
7400-            I     1               ; 00 (DOWN arrow)
7400-00          I     2               .db     %00000000
7401-FF          I     3               .db     %11111111
7402-81          I     4               .db     %10000001
7403-42          I     5               .db     %01000010
7404-24          I     6               .db     %00100100
7405-18          I     7               .db     %00011000
7406-00          I     8               .db     %00000000
7407-00          I     9               .db     %00000000
7408-            I    10
7408-            I    11               ; 01 (UP arrow)
7408-00          I    12               .db     %00000000
7409-18          I    13               .db     %00011000
740A-24          I    14               .db     %00100100
740B-42          I    15               .db     %01000010
740C-81          I    16               .db     %10000001
740D-FF          I    17               .db     %11111111
740E-00          I    18               .db     %00000000
740F-00          I    19               .db     %00000000
7410-            I    20
7410-            I    21               ; 02 (Upper left corner)
7410-00          I    22               .db     %00000000
7411-7F          I    23               .db     %01111111
7412-40          I    24               .db     %01000000
7413-5F          I    25               .db     %01011111
7414-50          I    26               .db     %01010000
7415-50          I    27               .db     %01010000
7416-50          I    28               .db     %01010000
7417-50          I    29               .db     %01010000
7418-            I    30
7418-            I    31               ; 03 (Upper line)
7418-00          I    32               .db     %00000000
7419-FF          I    33               .db     %11111111
741A-00          I    34               .db     %00000000
741B-FF          I    35               .db     %11111111
741C-00          I    36               .db     %00000000
741D-00          I    37               .db     %00000000
741E-00          I    38               .db     %00000000
741F-00          I    39               .db     %00000000
7420-            I    40
7420-            I    41               ; 04 (Upper right corner)
7420-00          I    42               .db     %00000000
7421-FE          I    43               .db     %11111110
7422-02          I    44               .db     %00000010
7423-FA          I    45               .db     %11111010
7424-0A          I    46               .db     %00001010
7425-0A          I    47               .db     %00001010
7426-0A          I    48               .db     %00001010
7427-0A          I    49               .db     %00001010
7428-            I    50
7428-            I    51               ; 05 (Lower line)
7428-00          I    52               .db     %00000000
7429-00          I    53               .db     %00000000
742A-00          I    54               .db     %00000000
742B-00          I    55               .db     %00000000
742C-FF          I    56               .db     %11111111
742D-00          I    57               .db     %00000000
742E-FF          I    58               .db     %11111111
742F-00          I    59               .db     %00000000
7430-            I    60
7430-            I    61               ; 06 (Lower left corner)
7430-50          I    62               .db     %01010000
7431-50          I    63               .db     %01010000
7432-50          I    64               .db     %01010000
7433-50          I    65               .db     %01010000
7434-5F          I    66               .db     %01011111
7435-40          I    67               .db     %01000000
7436-7F          I    68               .db     %01111111
7437-00          I    69               .db     %00000000
7438-            I    70
7438-            I    71               ; 07 (Lower right corner)
7438-0A          I    72               .db     %00001010
7439-0A          I    73               .db     %00001010
743A-0A          I    74               .db     %00001010
743B-0A          I    75               .db     %00001010
743C-FA          I    76               .db     %11111010
743D-02          I    77               .db     %00000010
743E-FE          I    78               .db     %11111110
743F-00          I    79               .db     %00000000
7440-            I    80
7440-            I    81               ; 08 (Left line)
7440-50          I    82               .db     %01010000
7441-50          I    83               .db     %01010000
7442-50          I    84               .db     %01010000
7443-50          I    85               .db     %01010000
7444-50          I    86               .db     %01010000
7445-50          I    87               .db     %01010000
7446-50          I    88               .db     %01010000
7447-50          I    89               .db     %01010000
7448-            I    90
7448-            I    91               ; 09 (Right line)
7448-0A          I    92               .db     %00001010
7449-0A          I    93               .db     %00001010
744A-0A          I    94               .db     %00001010
744B-0A          I    95               .db     %00001010
744C-0A          I    96               .db     %00001010
744D-0A          I    97               .db     %00001010
744E-0A          I    98               .db     %00001010
744F-0A          I    99               .db     %00001010
7500                792                       .NO             $7500,$FF
7500-                793       FONT1:  .BI             font1.bin
7800-                794                       .NO             $7800,$FF
7800-                795       FONT2:  .BI             font2.bin
7B00-                796
7B00-                797                       .NO             $7B00
7B00-                798       ATTRIBUTES:             ; Text and border attributes used.
7B00-                799       S_BORDER:               ; Used to set border in loader.
7B00-00              800                       .DB             A_BLACK
7B01-                801       S_BORDER_M:             ; Border colour once in the menu.
7B01-00              802                       .DB             A_BLACK
7B02-                803       S_DEFAULT:              ; Standard text
7B02-47              804                       .DB             A_P_BLACK|A_WHITE|A_BRIGHT
7B03-                805       S_TITLE:                ; Program title (MSG_TITLE)
7B03-47              806                       .DB             A_P_BLACK|A_WHITE|A_BRIGHT
7B04-                807       S_NAME:                 ; Cartridge title (TITLE0)
7B04-07              808                       .DB             A_P_BLACK|A_WHITE
7B05-                809       S_INACTIVE:             ; Inactive menu row.
7B05-07              810                       .DB             A_P_BLACK|A_WHITE
7B06-                811       S_ACTIVE:               ; Active menu row.
7B06-78              812                       .DB             A_P_WHITE|A_BLACK|A_BRIGHT
7B07-                813       S_HELP:                 ; Help text (MSG_HELP)
7B07-47              814                       .DB             A_P_BLACK|A_WHITE|A_BRIGHT
7B08-                815       S_ERROR                 ; Error screen text
7B08-42              816                       .DB             A_P_BLACK|A_RED|A_BRIGHT
7B09-                817       S_ERROR_TITLE:  ; Error screen title
7B09-C2              818                       .DB             A_P_BLACK|A_RED|A_BRIGHT|A_FLASH
7B0A-                819
7C00                820                       .NO             $7C00,$FF
7C00-20 20 20 20 
     20 20 20 20 
     43 61 72 74 
     72 69 64 67 
     65 20 4C 6F 
     61 64 65 72 
     20 20 20 20 
     20 20 20 00     821       TITLE0: .AZ             "        Cartridge Loader       "
7C20-                822                       .NO             $7C20,$00
7C20-20 4E 61 6D 
     65 20 31 00     823       TITLE1: .AZ             " Name 1"
7C40                824                       .NO             $7C40,$00
7C40-20 4E 61 6D 
     65 20 32 00     825       TITLE2: .AZ             " Name 2"
7C60                826                       .NO             $7C60,$00
7C60-20 4E 61 6D 
     65 20 33 00     827       TITLE3: .AZ             " Name 3"
7C80                828                       .NO             $7C80,$00
7C80-20 4E 61 6D 
     65 20 34 00     829       TITLE4: .AZ             " Name 4"
7CA0                830                       .NO             $7CA0,$00
7CA0-20 4E 61 6D 
     65 20 35 00     831       TITLE5: .AZ             " Name 5"
7CC0                832                       .NO             $7CC0,$00
7CC0-20 4E 61 6D 
     65 20 36 00     833       TITLE6: .AZ             " Name 6"
7CE0                834                       .NO             $7CE0,$00
7CE0-20 4E 61 6D 
     65 20 37 00     835       TITLE7: .AZ             " Name 7"
7D00                836                       .NO             $7D00,$00
7D00-20 4E 61 6D 
     65 20 38 00     837       TITLE8: .AZ             " Name 8"
7D20                838                       .NO             $7D20,$00
7D20-20 4E 61 6D 
     65 20 39 00     839       TITLE9: .AZ             " Name 9"
7D40                840                       .NO             $7D40,$00
7D40-                841       TITLE10:
7D40-20 4E 61 6D 
     65 20 41 00     842                       .AZ             " Name A"
7D60                843                       .NO             $7D60,$00
7D60-                844       TITLE11:
7D60-20 4E 61 6D 
     65 20 42 00     845                       .AZ             " Name B"
7D80                846                       .NO             $7D80,$00
7D80-                847       TITLE12:
7D80-20 4E 61 6D 
     65 20 43 00     848                       .AZ             " Name C"
7DA0                849                       .NO             $7DA0,$00
7DA0-                850       TITLE13:
7DA0-20 4E 61 6D 
     65 20 44 00     851                       .AZ             " Name D"
7DC0                852                       .NO             $7DC0,$00
7DC0-                853       TITLE14:
7DC0-20 4E 61 6D 
     65 20 45 00     854                       .AZ             " Name E"
7DE0                855                       .NO             $7DE0,$00
7DE0-                856       TITLE15:
7DE0-20 4E 61 6D 
     65 20 46 00     857                       .AZ             " Name F"
7FFC                858                       .NO             $7FFC,$00
7FFC-                859       SLOT_COUNT:
7FFC-03              860                       .DB             3
7FFD-00              861                       .DB             0
7FFE-00              862                       .DB             0
7FFF-00              863                       .DB             0
