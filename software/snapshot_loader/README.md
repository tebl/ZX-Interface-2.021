# Snapshot Loader
The ZX Spectrum wasn't originally designed to have cartridge support, I assume this was due to the rather excessive costs involved in creating one-off hardware like this at the time when it was designed. The expansion connector at the back of the computer did however have the capability of disabling the system ROM found inside the machine, no doubt with the intention of allowing peripherals to upgrade the machine in this way.

This is what they did with the release of the Sinclair Interface 1, replacing the built-in ROM with one that supported the Microdrive and RS232 hardware that it added. The Interface 2 that was released sometime later did not come with a ROM by itself, this was moved onto individual cartridges like what people at that point had come to expect. The did however make a few mistakes, the biggest one was designing it in a way that made it hard to access more than the initial 16K ROM found on the cartridge - at a time when games had started to adopt the larger capabilities of the 48K machines. While I've sought to improve the hardware side of things when designing the *ZX Interface 2.021*, it still sees software in 16K segments and we need some software to handle switching between the available 16K banks of data (see [bank switching](https://github.com/tebl/ZX-Interface-2.021/blob/main/documentation/bank_switching.md) for a more general description on how that is done).

The *Snapshot Loader* is actually the second loader I've written for the *ZX Interface 2.021*, the other is the [Cartridge Loader](https://github.com/tebl/ZX-Interface-2.021/tree/main/software/cartridge_loader) and handles the traditional 16K ROM-files available for the ZX Spectrum. Back to the *Snapshot Loader* again, this one instead of dealing with ready-made cartridge images focuses on snapshot-files ([*.SNA*](https://worldofspectrum.org/faq/reference/formats.htm) files) - more than likely created by the computer itself (using additional hardware such as the Multiface).

The snapshot, when created freezes the contents of a running program by copy all parts of the running computer - the entire 48K of RAM, as well as the CPU registers added to the start of the snapshot as a header. So in order to restore a snapshots, we'd just need to restore all of the RAM and set the CPU registers equal to what it was when the computer was frozen. All of that is easy stuff, on an emulator. When doing it on the computer itself, it's an entirely different situation as you need at least some of those register to keep track of where we are in the process - essentially counting fingers, breaking one off for every step. Anyway, that's my explanation for the state of the code.

When it comes to the final steps of the restoration process, we need to bank out the code we're running in order to get back the standard ZX Spectrum ROM. Doing this when running code from the ROM at the same time is a guaranteed crash of some sort, so we'll need to use some small amount of RAM for this part of the program (13 bytes to be specific) and jump to that location to run it. This location is referred to as the *LOADER_ADR* by the assembly code, *LoaderAddress* in the [Snapshot Creator](https://github.com/tebl/ZX-Interface-2.021/tree/main/software/cartridge_creator) and if this is left at the default value of 0x0000 (2 bytes) - we'll attempt to figure this out for ourselves. The strategy for doing this is to take the snapshots SP-value (Stack Pointer) and subtract 17 addresses and place the program there (we're leaving 4 bytes for actual stack usage). The routine will then perform a *RETN*-instructions, normally only used to end interrupt handlers that pop the current stack value and resume the program from there (this value will have been added when the snapshot was created).

 That should just about cover it when it comes to describing what the *Snapshot Loader* does, but for those that just want to create their own cartridge compilations and have fun doing that - I've put together a [Cartridge Creator](https://github.com/tebl/ZX-Interface-2.021/tree/main/software/cartridge_creator) that will do most of the heavy lifting when it comes to dealing with the loader.

# 1> Assembling the code
This section is mostly for those that want to reprogram parts of the loader, the binary files are included in the repository so unless you want to assemble it yourself there shouldn't be a need to actually do so. The program is written in Z80 Machine Language, and as everyone who's attempted to do so - there is a lot of differences in the code due to the various dialects used by the assembler, every program therefore needs to be paired with the assesmbler it was written for.

The one I'm using is the [SB-Assembler 3](https://www.sbprojects.net/sbasm/index.php), it is open source and written in [Python](https://www.python.org/) so you should be able to use it on all common platforms without issues - just download and unzip the assembler files somewhere you'll be able to find them. I'm using Windows, for some reason, so there are batch-files accompanying the source code - these assume that you've added the location of the assembler in your PATH-variable. Double-click the file named *__assemble.bat* to assemble the output, then pause to allow you to actually see the command-line output before the batch execution finishes.

I've tried quite a few solutions for developing, assembling and testing out code for the ZX Spectrum and most of them quite simply don't work or can be considered more *proofs of concept* rather than usable setups. Your mileage may wary though, but this is the state of things as I see it. Most emulators are quite good at playing games, but they have varying amounts of helpful tools when it comes to testing out new code. For developing the *Cartridge Loader*, a cartridge ROM, the solution that worked for me was the ZXSpin emulator and using *Tools -> Options... -> ROM Images* and setting *ROM Image* to point to the file generated by the assembler (*snapshot.rom*).

![ZXSpin Options](https://github.com/tebl/ZX-Interface-2.021/raw/main/gallery/ZXSpin_Options.png)

# 2> References
Everything comes from something, so does every bit of code created from earlier code found in manuals and blogs. Particularly helpful was a series of blog posts on a site called [Break into program](http://www.breakintoprogram.co.uk/) which in addition of a copy of *Spectrum Machine language for the absolute beginner* by William Tang inspired most of the code. The bugs are probably all mine.